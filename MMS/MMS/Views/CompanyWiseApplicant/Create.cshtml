@model MMS.Entities.Models.CompanyWiseApplicant
@{
    ViewBag.Title = "Company Applicant Map";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var CompanyApplicantMap = {
            listApplicant: "<tr><td>[ApplicantId]</td><td>[ApplicantName]</td><td>[ApplicantCountry]</td><td><button type='button' class='remove btn btn-danger btn-sm'><span class='glyphicon glyphicon-remove-sign'></span>Delete</button></td></tr>",

            Applicant: [],
            Initialize: function () {



                $("#page-leftbar li").removeClass("active");

                $("#liApplicant").addClass("active");
                $("#liCompanyApplicant").addClass("active");



                var $tabs = $('#tblApplicant');
                $("tbody.connectedSortable").sortable({
                    connectWith: ".connectedSortable",
                    //items: "> tr:not(:first)",
                    appendTo: $tabs,
                    helper: "clone",
                    zIndex: 999990
                })
                   .disableSelection()
                ;

                var $tab_items = $(".nav-tabs > li", $tabs).droppable({
                    accept: ".connectedSortable tr",
                    hoverClass: "ui-state-hover",

                    drop: function (event, ui) {
                        return false;
                    }
                });
                $(document).on('keypress', 'input#searchItem', function (e) {

                    var code = (e.keyCode ? e.keyCode : e.which);
                    if (code == 13) { //Enter keycode

                        $("#btnAdd").trigger("click");
                    }
                });
                $("#btnAdd").click(function () {

                    var searchItem = $("#searchItem").val();
                    var applicantId = $("#ApplicantId").val();
                    var applicantName = $("#ApplicantName").val();
                    var applicantCountry = $("#ApplicantCountry").val();
                    if (searchItem == '') {
                        alert("Please give the Applicant Info.");
                        return false;
                    }
                    var CompanyId = $("#CompanyDDL option:selected").val();
                    if (CompanyId == "" || CompanyId == 0) {
                        alert("Please Select the Company.");

                        return false;
                    }

                    var value = CompanyApplicantMap.listApplicant.replace("[ApplicantId]", applicantId).replace("[ApplicantName]", applicantName).replace("[ApplicantCountry]", applicantCountry);

                    var isDuplicate = false;


                    $("#tblApplicant tr").each(function (index) {
                        $("td", this).each(function (index) {
                            if ($(this).html() == applicantId) {
                                isDuplicate = true;
                                $("#searchItem").val('');
                                $("#ApplicantId").val('');
                                $("#ApplicantName").val('');
                                $("#ApplicantCountry").val('');
                                CompanyApplicantMap.Typehead();
                                return false;
                            }
                        });
                        if (isDuplicate == true) {
                            $(this).addClass("danger");
                            return false;
                        }
                    });

                    if (isDuplicate == false) {
                        var len = $('#tbApplicant tr').length;
                        if (len == 0) {
                            $("#tbApplicant").prepend(value);
                            $("#tbApplicant tr:last").addClass("success");
                        }
                        else {
                            $("#tbApplicant tr:last").after(value);
                            $("#tbApplicant tr:last").addClass("success");
                        }

                        $("#searchItem").val('');
                        $("#ApplicantId").val('');
                        $("#ApplicantName").val('');
                        $("#ApplicantCountry").val('');

                        CompanyApplicantMap.Typehead();
                    }
                    $("#searchItem").focus();
                });

                CompanyApplicantMap.Typehead();
            },
            Typehead: function () {
                //var CompanyId = $("#CompanyDDL option:selected").val();
                //if (CompanyId==0) {
                //    alert("Please Select Company.")
                //    $("#searchItem").val('');
                //    $("#searchItem").focus()
                //    return false;
                //}
                $('#searchItem').typeahead('destroy');
                $('#searchItem').typeahead({
                    hint: true,
                    highlight: true,
                    minLength: 1
                },
                {
                    items: 8,
                    name: 'Id',
                    displayKey: 'Name',
                    property: "Name",
                    source: function (UserName, process) {
                        var url = '@Url.Content("~/Applicant/GetCompletedApplicantListForCompanyMap")';
                        return $.getJSON(url, { searchItem: $("#searchItem").val() }, function (data) {

                            var CompanyId = $("#CompanyDDL option:selected").val();
                            if (CompanyId == 0) {
                                alert("Please Select Company.")
                                $("#searchItem").val('');
                                $("#searchItem").focus()
                                return false;
                            }
                            $("#searchItem").val('');
                            $("#searchItem").focus()
                            return process(data);

                        });
                    },
                    updater: function (item) {
                        return item.Name;
                    }
                }).on('typeahead:selected', function (obj, datum) {
                    if (datum.IsAlreadyMappedWithCompany==true) {
                        alert("Applicant Already Mapped.");
                        $("#searchItem").val('');
                        $("#searchItem").focus();
                        return false;
                    }
                    $("#ApplicantId").val(datum.ID);
                    $("#ApplicantName").val(datum.Name);
                    $("#ApplicantCountry").val(datum.ApplicantCountryName_vw);
                    $("#searchItem").focus();
                });
            },

            CompanyApplicantMapSubmit: function () {

                var url = '@Url.Content("~/CompanyWiseApplicant/Create")';
                var param = JSON.stringify({ 'lstCompanyWiseApplicant': CompanyApplicantMap.Applicant });
                $.ajax({
                    type: "POST",
                    url: url,
                    data: param,
                    success: function (Data) {
                        if (Data) {
                            window.location = '@Url.Content("~/CompanyWiseApplicant/index")';
                        }
                        else {
                            alert("Exception occured.");
                        }

                    },
                    contentType: 'application/json; charset=utf-8',
                });
            }

        }

        CompanyApplicantMap.Initialize();

        $(document).on('click', 'button.remove', function () {
            $(this).parent("td").parent("tr").remove();
        });

        $("#btnSubmit").click(function () {

            CompanyApplicantMap.Applicant = new Array;
            var CompanyId = $("#CompanyDDL option:selected").val();
            $("#tbApplicant tr").each(function (index) {
                var ApplicantgArr = {
                    ID: '',
                    CompanyId: '',
                    ApplicantId: ''
                }
                $("td", this).each(function (index) {
                    //if (index == 0) {

                    //    ApplicantgArr.ID = $(this).find(":input").val();
                    //}

                    if (index == 0) {
                        ApplicantgArr.ApplicantId = $(this).html();;
                    }

                    //if (index == 1) {
                    //    ApplicantgArr.CompanyId = $(this).html();
                    //}
                });
                ApplicantgArr.CompanyId = CompanyId;
                CompanyApplicantMap.Applicant.push(ApplicantgArr);
            });




            if (CompanyApplicantMap.Applicant.length > 0) {
                CompanyApplicantMap.CompanyApplicantMapSubmit();
            }
            else {
                alert("Applicant Not found.");
            }


        });

    });


</script>
<script src="~/dist/js/bootstrap-select.js"></script>
@section breadcrumb
{
    <li><a href="~/Dashboard/index">Dashboard</a></li>
    <li>Applicant Operation</li>
    <li class="active">Company Applicant Map</li>
}

<style type="text/css">
  

    .backTolist {
        font-size: 1em;
        font-weight: normal;
    }

        .backTolist:hover {
            text-decoration: none;
        }

    .fileSets {
        border: 1px dotted #ddd;
        margin: 0px 10px 20px 0;
        padding: 20px 10px 0px 10px;
    }

    .required:after {
        content: " *";
        color: #f00;
    }

    legend.scheduler-border {
        width: inherit; /* Or auto */
        padding: 0 10px; /* To give a bit of padding on the left and right */
        border-bottom: none;
    }
</style>
<p> @Html.ActionLink("Go Back to List", "Index", null, null, new { @class = "btn btn-success" })</p>
<hr />
<div class="panel-body collapse in" id="attendeesCollapse">
    <div class="form-group col-sm-12">
        <div class="col-sm-5" style="margin-left:-20px">
            @Html.Label("Company Name")
            @Html.DropDownListFor(model => model.CompanyId, new SelectList(Model.kvpCompany, "Key", "Value", Model.CompanyId), "Select Company", new { id = "CompanyDDL", @class = "form-control" })
            @Html.ValidationMessageFor(model => model.CompanyId)

        </div>
    </div>

    <div id="useinfo" class="row">
        <div class="col-md-12 margin-0">
            <div class="form-group">
                <div class=" col-md-3">
                    @Html.Label("Applicant Search")
                    <input id="searchItem" class="form-control" type="text" placeholder="">
                </div>
                <div class="col-md-3">
                    @Html.Label("Applicant Id")
                    <input id="ApplicantId" class="form-control" type="text" readonly placeholder="Applicant Id">
                </div>
                <div class="col-md-3">
                    @Html.Label("Applicant Name")
                    <input id="ApplicantName" class="form-control" type="text" readonly placeholder="Applicant Name">
                </div>
                <div class="col-md-3">
                    @Html.Label("Country")
                    <input id="ApplicantCountry" class="form-control" type="text" readonly placeholder="Applicant Country">
                </div>
            </div>
        </div>
        <div class="col-md-2 margin-0">
            <div class="col-md-3">
                <label>&nbsp;</label>
                <input id="btnAdd" type="button" value="Add" class="btn btn-primary " />
            </div>
        </div>

    </div>

    <div id="attendees" class="form-group">
        <table id="tblApplicant" class="table table-hover">
            <thead>
                <tr>
                    <th>Applicant Id</th>
                    <th>Applicant Name</th>
                    <th>Applicant Country</th>

                    <th></th>
                </tr>
                <hr />
            </thead>

            <tbody id="tbApplicant" class="connectedSortable"></tbody>

            <tfoot>
                <tr id="">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>

                </tr>
            </tfoot>
        </table>
    </div>
    <div class="form-group col-md-12">
        <div>
            <input id="btnSubmit" type="button" value="Submit" class="btn btn-default pull-left" onclick=" return AddConfirm()" />
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/bootstrapth")
}
